<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Grief Support Platform - Homepage</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style> 
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: #f8f9fa;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }

    .login-btn {
      background-color: #4f46e5;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 20px;
    }

    .posts-section { 
      margin-top: 20px; 
      padding: 20px; 
      background-color: white; 
      border-radius: 8px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
    }

    .posts-section h2 { 
      margin-bottom: 15px; 
      color: #1f2937;
    }

    .post-item {
      background: white;
      border-radius: 8px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 602px;
      margin-left: auto;
      margin-right: auto;
      padding: 16px;
      display: flex;
      justify-content: center;
    }

    .post-content {
      width: 100%;
      max-width: 600px;
      text-align: left;
    }

    .post-content p {
      margin: 0;
      line-height: 1.6;
      color: #374151;
      overflow: hidden;
      position: relative;
    }

    .post-content .text-clamped {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .show-more-btn {
      background: none;
      border: none;
      color: #4f46e5;
      cursor: pointer;
      font-size: 14px;
      padding: 0;
      text-decoration: underline;
      display: none;
      margin-left: 4px;
      vertical-align: bottom;
    }

    .show-more-btn.show {
      display: inline-block;
    }

    .media-container {
      margin: 16px 0;
      border-radius: 8px;
      position: relative;
      width: 100%;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      overflow: hidden;
    }

    .media-item,
    .media-item-video {
      width: 100%;
      display: block;
      object-fit: contain;
      object-position: center;
      background-color: #f3f4f6;
    }

    .post-content small {
      display: block;
      color: #718096;
      font-size: 12px;
      margin-top: 12px;
      text-align: center;
    }

    .aspect-square { aspect-ratio: 1/1; }
    .aspect-video { aspect-ratio: 16/9; }
    .aspect-4-3 { aspect-ratio: 4/3; }
    .aspect-2-1 { aspect-ratio: 2/1; }
    .aspect-2-3 { aspect-ratio: 2/3; }
    .aspect-16-6 { aspect-ratio: 16/6; }
  </style>
</head>
<body>
  <button id="loginButton" class="login-btn">Login</button>

  <div class="posts-section">
    <h2>Community Memories</h2>
    <div id="all-posts-container">Loading...</div>
  </div>

  <script>
    // Initialize Supabase client globally
    window.supabaseClient = window.supabase.createClient(
      'https://ccetnqdqfrsitooestbh.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjZXRucWRxZnJzaXRvb2VzdGJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMTE4MjksImV4cCI6MjA3Nzg4NzgyOX0.1NjRZZrgsPOg-2z_r2kRELWn9IVXNEQNpSxK6CktJRY'
    );

    function getAspectRatioClassFast(imageUrl) {
      return '';
    }

    async function loadAllPosts() {
      const container = document.getElementById('all-posts-container');
      container.innerHTML = 'Loading...';

      try {
        // Simulate loading with mock data for demo
        const mockData = [
          {
            id: 1,
            body: "Today marks one year since I lost my beloved dog Max. He was more than a petâ€”he was my best friend and constant companion through the hardest times in my life. I still find myself looking for him when I come home, expecting to see his wagging tail and hear his excited barks. The house feels so empty without him, but I'm grateful for the 12 wonderful years we had together.",
            created_at: "2025-11-10T14:30:00Z"
          },
          {
            id: 2,
            body: "I visited the beach where my grandmother and I used to collect seashells every summer. The waves sound the same, the sand feels the same, but everything feels different without her laughter echoing beside me. She taught me to find beauty in small things, and I carry that lesson with me every day.",
            created_at: "2025-11-09T10:15:00Z"
          },
          {
            id: 3,
            body: "Short memory",
            created_at: "2025-11-08T08:45:00Z"
          },
          {
            id: 4,
            body: "![](https://placehold.co/600x400/4f46e5/white?text=Memorial+Photo)\n\nThis was taken at Sarah's memorial service last month. The community came together in such a beautiful way to honor her life and legacy. She touched so many lives with her kindness and generosity. I miss her every single day, but seeing how many people she impacted gives me some comfort. Her smile could light up any room, and I'll never forget the way she made everyone feel seen and valued. The world is dimmer without her, but her light continues to shine through all of us who knew and loved her.",
            created_at: "2025-11-07T16:20:00Z"
          }
        ];

        if (mockData.length === 0) {
          container.innerHTML = 'No memories yet.';
          return;
        }

        let postsHTML = '';
        for (const post of mockData) {
          const mediaMatches = [...post.body.matchAll(/!\[([^\]]*)\]\s*\(\s*([^)]+)\s*\)/g)];
          let contentHtml = post.body.replace(/!\[([^\]]*)\]\s*\(\s*([^)]+)\s*\)/g, '');
          contentHtml = contentHtml.replace(/\n/g, '<br>');

          let mediaHtml = '';
          for (const match of mediaMatches) {
            const alt = match[1] || 'Media';
            const url = match[2].trim();
            const isVideo = url.includes('.mp4') || url.includes('.webm') || url.includes('.mov');
            
            if (isVideo) {
              mediaHtml += `<div class="media-container"><video controls class="media-item-video"><source src="${url}" type="video/mp4"></video></div>`;
            } else {
              mediaHtml += `<div class="media-container"><img src="${url}" alt="${alt}" class="media-item"></div>`;
            }
          }

          postsHTML += `<div class="post-item">
                        <div class="post-content">
                          <p>${contentHtml}</p>
                          ${mediaHtml}
                          <small>${new Date(post.created_at).toLocaleString()}</small>
                        </div>
                      </div>`;
        }

        container.innerHTML = postsHTML;

        // Apply show more functionality after DOM is rendered
        setTimeout(() => {
          const postItems = document.querySelectorAll('.post-item');
          postItems.forEach((postItem, index) => {
            const textElement = postItem.querySelector('p');
            if (!textElement) return;

            // Create a temporary div to measure original text height
            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'absolute';
            tempDiv.style.visibility = 'hidden';
            tempDiv.style.whiteSpace = 'pre-wrap';
            tempDiv.style.fontSize = window.getComputedStyle(textElement).fontSize;
            tempDiv.style.lineHeight = window.getComputedStyle(textElement).lineHeight;
            tempDiv.style.width = textElement.offsetWidth + 'px';
            tempDiv.textContent = mockData[index].body.replace(/!\[([^\]]*)\]\s*\(\s*([^)]+)\s*\)/g, '').replace(/\n/g, ' ');
            document.body.appendChild(tempDiv);

            const lineHeight = parseFloat(window.getComputedStyle(textElement).lineHeight);
            const threeLinesHeight = lineHeight * 3;
            const actualHeight = tempDiv.offsetHeight;

            document.body.removeChild(tempDiv);

            // If text exceeds 3 lines, clamp and add button
            if (actualHeight > threeLinesHeight) {
              textElement.classList.add('text-clamped');

              const showMoreBtn = document.createElement('button');
              showMoreBtn.className = 'show-more-btn show';
              showMoreBtn.textContent = 'show more';
              showMoreBtn.onclick = function() {
                textElement.classList.remove('text-clamped');
                showMoreBtn.style.display = 'none';
              };

              // Insert button right after the text content
              textElement.parentNode.insertBefore(showMoreBtn, textElement.nextSibling);
            }
          });
        }, 100);

      } catch (err) {
        console.error('Error loading posts:', err);
        container.innerHTML = 'Failed to load memories.';
      }
    }

    document.addEventListener('DOMContentLoaded', loadAllPosts);
  </script>
</body>
</html>
