<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Grief Support Platform - Homepage</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: #f8f9fa;
      padding: 2px;
      max-width: 800px;
      margin: 0 auto;
    }

    /* Header styles */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      font-size: 1.2rem;
      font-weight: 700;
      color: #5a67d8;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: linear-gradient(45deg, #5a67d8, #9f7aea);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 1.1rem;
      cursor: pointer;
    }
    
    .login-btn {
      background-color: #4f46e5;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      margin-left: 12px;
    }

    .posts-section { 
      margin-top: 20px; 
      padding: 20px; 
      background-color: white; 
      border-radius: 8px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
    }

    .posts-section h2 { 
      margin-bottom: 15px; 
      color: #1f2937;
    }

    .post-item {
      background: white;
      border-radius: 8px;
      margin-bottom: 40px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      padding: 15px;
      display: flex;
      flex-direction: column;
    }

    .post-header {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      gap: 12px;
    }

    .profile-image {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
      background-color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #6b7280;
    }

    .profile-info {
      display: flex;
      flex-direction: column;
    }

    .username {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 2px;
    }

    .post-date {
      font-size: 0.85rem;
      color: #718096;
    }

    .post-content {
      width: 100%;
      text-align: left;
    }

    .text-container {
      position: relative;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .text-container.expanded {
      -webkit-line-clamp: unset;
      -webkit-box-orient: unset;
      display: block;
    }

    .text-container::after {
      content: '...';
      position: absolute;
      bottom: 0;
      right: 0;
      background: white;
      padding-left: 5px;
    }

    .text-container.expanded::after {
      content: '';
    }

    .post-content p {
      margin: 0;
      line-height: 1.6;
      color: #374151;
    }

    .show-more-btn {
      background: none;
      border: none;
      color: #4f46e5;
      cursor: pointer;
      font-size: 0.9em;
      padding: 0;
      margin-top: 4px;
      text-decoration: underline;
      font-weight: 600;
      display: none;
    }

    .show-more-btn.visible {
      display: inline;
    }

    .media-container {
      margin: 10px 0;
      border-radius: 8px;
      position: relative;
      width: 100%;
      overflow: hidden;
    }

    .media-item,
    .media-item-video {
      width: 100%;
      display: block;
      object-fit: contain;
      object-position: center;
      background-color: #f3f4f6;
    }

    /* Bottom Navigation Styles */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: white;
      display: flex;
      justify-content: space-around;
      padding: 12px 0;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
      z-index: 99;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      font-size: 0.8rem;
      color: #718096;
    }

    .nav-item.active {
      color: #5a67d8;
    }

    .nav-item i {
      font-size: 1.4rem;
    }

    /* Group List Styles */
    .group-list {
      display: none;
      flex-direction: column;
      gap: 12px;
      margin-top: 15px;
    }

    .group-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: #f8fafc;
      border-radius: 8px;
      border-left: 4px solid #5a67d8;
    }

    .group-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(45deg, #5a67d8, #9f7aea);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 1.1rem;
    }

    .group-info {
      flex: 1;
    }

    .group-name {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 4px;
    }

    .group-meta {
      font-size: 0.85rem;
      color: #718096;
    }

    /* Notification List Styles */
    .notification-list {
      display: none;
      flex-direction: column;
      gap: 12px;
      margin-top: 15px;
    }

    .notification-item {
      padding: 12px;
      background: #f8fafc;
      border-radius: 8px;
      border-left: 4px solid #48bb78;
    }

    .notification-text {
      color: #374151;
      line-height: 1.5;
    }

    .notification-time {
      font-size: 0.8rem;
      color: #718096;
      margin-top: 4px;
    }

    /* Call/Social Features */
    .social-features {
      display: none;
      flex-direction: column;
      gap: 12px;
      margin-top: 15px;
    }

    .social-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: #f8fafc;
      border-radius: 8px;
      border-left: 4px solid #ed8936;
    }

    .social-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(45deg, #ed8936, #f6ad55);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.1rem;
    }

    .social-info {
      flex: 1;
    }

    .social-name {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 4px;
    }

    .social-meta {
      font-size: 0.85rem;
      color: #718096;
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="logo">
      <i class="fas fa-heart-circle"></i> Healing
    </div>
    <div class="user-menu">
      <button class="action-btn" id="messageButton" style="background: none; border: none; padding: 8px; cursor: pointer;">
        <i class="fas fa-envelope"></i>
      </button>
      <button class="action-btn" id="callButton" style="background: none; border: none; padding: 8px; cursor: pointer;">
        <i class="fas fa-phone"></i>
      </button>
      <div class="user-avatar" id="userAvatar">U</div>
      <button id="loginButton" class="login-btn">Login</button>
    </div>
  </div>

  <div class="posts-section">
    <h2 id="section-title">Community Memories</h2>
    <div id="all-posts-container">Loading...</div>
    <div id="group-list" class="group-list">
      <!-- Groups will be populated here -->
    </div>
    <div id="notification-list" class="notification-list">
      <!-- Notifications will be populated here -->
    </div>
    <div id="social-features" class="social-features">
      <!-- Social features will be populated here -->
    </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <a href="/test" class="nav-item" data-page="dashboard">
      <i class="fas fa-tachometer-alt"></i>
      <span>Dashboard</span>
    </a>
    <div class="nav-item" data-page="community">
      <i class="fas fa-users"></i>
      <span>Community</span>
    </div>
    <a href="/progress" class="nav-item" data-page="progress">
      <i class="fas fa-book"></i>
      <span>Progress</span>
    </a>
    <div class="nav-item" data-page="notifications">
      <i class="fas fa-bell"></i>
      <span>Notifications</span>
    </div>
    <div class="nav-item" data-page="resources">
      <i class="fas fa-leaf"></i>
      <span>Help</span>
    </div>
  </div>

  <script>
    // Initialize Supabase client globally
    window.supabaseClient = window.supabase.createClient(
      'https://ccetnqdqfrsitooestbh.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjZXRucWRxZnJzaXRvb2VzdGJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMTE4MjksImV4cCI6MjA3Nzg4NzgyOX0.1NjRZZrgsPOg-2z_r2kRELWn9IVXNEQNpSxK6CktJRY'
    );

    // Function to check login status and update button
    async function updateLoginButton() {
      const loginButton = document.getElementById('loginButton');
      const user = await window.supabaseClient.auth.getUser();
      
      if (user.data.user) {
        // User is logged in
        loginButton.textContent = 'Logout';
        loginButton.onclick = async function() {
          await window.supabaseClient.auth.signOut();
          window.location.href = '/';
        };
      } else {
        // User is not logged in
        loginButton.textContent = 'Login';
        loginButton.onclick = function() {
          window.location.href = '/login/';
        };
      }
    }

    async function loadAllPosts() {
      const container = document.getElementById('all-posts-container');
      const groupList = document.getElementById('group-list');
      const notificationList = document.getElementById('notification-list');
      const socialFeatures = document.getElementById('social-features');
      const sectionTitle = document.getElementById('section-title');
      
      // Reset displays
      container.style.display = 'block';
      groupList.style.display = 'none';
      notificationList.style.display = 'none';
      socialFeatures.style.display = 'none';
      sectionTitle.textContent = 'Community Memories';

      container.innerHTML = 'Loading...';

      try {
        const { data, error } = await window.supabaseClient
          .from('memories')
          .select('id, body, created_at, user_id')
          .order('created_at', { ascending: false });

        if (error) throw error;

        if (data.length === 0) {
          container.innerHTML = 'No memories yet.';
          return;
        }

        // Format month and year (e.g., "November 2025")
        const formatDate = (dateString) => {
          const date = new Date(dateString);
          return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        };

        // List of generic names to simulate different users
        const genericNames = [
          'Sarah Johnson', 'Michael Chen', 'Emma Rodriguez', 'David Kim',
          'Lisa Thompson', 'James Wilson', 'Maria Garcia', 'Robert Taylor',
          'Jennifer Lee', 'William Brown', 'Amanda Davis', 'Christopher Miller',
          'Michelle Jackson', 'Daniel Smith', 'Ashley White', 'Matthew Anderson',
          'Stephanie Martinez', 'Joshua Thomas', 'Nicole Hernandez', 'Ryan Moore'
        ];

        const postsHTML = data.map((post, index) => {
          // Use a generic name based on the post index
          const authorName = genericNames[index % genericNames.length];
          
          // Extract media
          const mediaMatches = [...post.body.matchAll(/!\[([^\]]*)\]\s*\(\s*([^)]+)\s*\)/g)];
          let contentHtml = post.body.replace(/!\[([^\]]*)\]\s*\(\s*([^)]+)\s*\)/g, '');
          contentHtml = contentHtml.replace(/\n/g, '<br>');

          // Generate user initials from the generic name
          const nameParts = authorName.split(' ');
          const initials = nameParts.map(part => part[0]).join('').toUpperCase();
          
          // Format date to show only month and year
          const postDate = formatDate(post.created_at);

          let mediaHtml = '';
          for (const match of mediaMatches) {
            const alt = match[1] || 'Media';
            const url = match[2].trim();
            const isVideo = url.includes('.mp4') || url.includes('.webm') || url.includes('.mov');
            
            if (isVideo) {
              mediaHtml += `<div class="media-container"><video controls class="media-item-video"><source src="${url}" type="video/mp4"></video></div>`;
            } else {
              mediaHtml += `<div class="media-container"><img src="${url}" alt="${alt}" class="media-item"></div>`;
            }
          }

          return `<div class="post-item">
                    <div class="post-header">
                      <div class="profile-image">${initials}</div>
                      <div class="profile-info">
                        <div class="username">${authorName}</div>
                        <div class="post-date">${postDate}</div>
                      </div>
                    </div>
                    <div class="post-content">
                      <div class="text-container">
                        <p>${contentHtml}</p>
                      </div>
                      <button class="show-more-btn">Show more</button>
                      ${mediaHtml}
                    </div>
                  </div>`;
        }).join('');

        container.innerHTML = postsHTML;

        // Process each post to determine if "Show more" button is needed
        document.querySelectorAll('.post-item').forEach(postItem => {
          const textContainer = postItem.querySelector('.text-container');
          const showMoreBtn = postItem.querySelector('.show-more-btn');
          
          // Temporarily expand to measure full height
          const originalLineClamp = textContainer.style.webkitLineClamp;
          textContainer.style.webkitLineClamp = 'unset';
          textContainer.style.webkitBoxOrient = 'unset';
          textContainer.classList.add('expanded');
          
          const expandedHeight = textContainer.scrollHeight;
          
          // Reset to original state
          textContainer.style.webkitLineClamp = originalLineClamp;
          textContainer.style.webkitBoxOrient = 'vertical';
          textContainer.classList.remove('expanded');
          
          // Calculate height with line clamp applied
          const clampedHeight = textContainer.scrollHeight;
          
          // Show button only if content is truncated
          if (expandedHeight > clampedHeight) {
            showMoreBtn.classList.add('visible');
          }
          
          // Add event listener for the button
          showMoreBtn.addEventListener('click', () => {
            textContainer.classList.toggle('expanded');
            showMoreBtn.textContent = textContainer.classList.contains('expanded') ? 'Show less' : 'Show more';
          });
        });

      } catch (err) {
        console.error('Error loading posts:', err);
        container.innerHTML = 'Failed to load memories.';
      }
    }

    // Function to show groups
    function showGroups() {
      const container = document.getElementById('all-posts-container');
      const groupList = document.getElementById('group-list');
      const notificationList = document.getElementById('notification-list');
      const socialFeatures = document.getElementById('social-features');
      const sectionTitle = document.getElementById('section-title');
      
      // Reset displays
      container.style.display = 'none';
      groupList.style.display = 'flex';
      notificationList.style.display = 'none';
      socialFeatures.style.display = 'none';
      sectionTitle.textContent = 'Your Groups';

      // Sample groups data with exaggerated numbers
      const groups = [
        { name: 'Loss Parents Support', members: 245000, postsToday: 12000 },
        { name: 'Sudden Death Grief', members: 189000, postsToday: 8500 },
        { name: 'Suicide Loss Survivors', members: 312000, postsToday: 15000 },
        { name: 'Caregivers Who Lost', members: 97000, postsToday: 5200 },
        { name: 'Young Widows Support', members: 63000, postsToday: 3100 },
        { name: 'Grief After Addiction', members: 142000, postsToday: 7800 },
        { name: 'Military Loss Support', members: 89000, postsToday: 4200 },
        { name: 'Child Loss Parents', members: 156000, postsToday: 9300 }
      ];

      const groupsHTML = groups.map(group => `
        <div class="group-item">
          <div class="group-avatar">${group.name.charAt(0)}</div>
          <div class="group-info">
            <div class="group-name">${group.name}</div>
            <div class="group-meta">${group.members.toLocaleString()} members â€¢ ${group.postsToday.toLocaleString()} new posts today</div>
          </div>
          <i class="fas fa-chevron-right" style="color: #a0aec0;"></i>
        </div>
      `).join('');

      groupList.innerHTML = groupsHTML;
    }

    // Function to show notifications
    function showNotifications() {
      const container = document.getElementById('all-posts-container');
      const groupList = document.getElementById('group-list');
      const notificationList = document.getElementById('notification-list');
      const socialFeatures = document.getElementById('social-features');
      const sectionTitle = document.getElementById('section-title');
      
      // Reset displays
      container.style.display = 'none';
      groupList.style.display = 'none';
      notificationList.style.display = 'flex';
      socialFeatures.style.display = 'none';
      sectionTitle.textContent = 'Notifications';

      // Sample notifications data
      const notifications = [
        { text: 'Sarah liked your memory of your dad', time: '2 hours ago' },
        { text: 'New post in "Loss Parents Support" (245K members)', time: '4 hours ago' },
        { text: 'John joined your group "Sudden Death Grief"', time: '1 day ago' },
        { text: 'Reminder: Your memorial post is one year old today', time: '1 day ago' },
        { text: 'Emma commented on your story', time: '2 days ago' },
        { text: 'New resource added to "Grief After Addiction"', time: '3 days ago' },
        { text: 'Live call starting in 10 minutes: "Coping with Holidays"', time: 'Just now' },
        { text: 'You have 12 unread messages from your support circle', time: '5 minutes ago' }
      ];

      const notificationsHTML = notifications.map(notification => `
        <div class="notification-item">
          <div class="notification-text">${notification.text}</div>
          <div class="notification-time">${notification.time}</div>
        </div>
      `).join('');

      notificationList.innerHTML = notificationsHTML;
    }

    // Function to show social features
    function showSocialFeatures() {
      const container = document.getElementById('all-posts-container');
      const groupList = document.getElementById('group-list');
      const notificationList = document.getElementById('notification-list');
      const socialFeatures = document.getElementById('social-features');
      const sectionTitle = document.getElementById('section-title');
      
      // Reset displays
      container.style.display = 'none';
      groupList.style.display = 'none';
      notificationList.style.display = 'none';
      socialFeatures.style.display = 'flex';
      sectionTitle.textContent = 'Connect & Share';

      // Sample social features data
      const features = [
        { name: 'Share Your Story', desc: 'Create a memory post to share with your community' },
        { name: 'Join Group Call', desc: 'Connect with others in real-time grief support sessions' },
        { name: 'Send Voice Message', desc: 'Share your thoughts without typing' },
        { name: 'Create Memorial Page', desc: 'Build a lasting tribute for your loved one' },
        { name: 'Find Local Support', desc: 'Connect with nearby grief support groups' },
        { name: 'Share Photo Album', desc: 'Create a shared photo collection with others' },
        { name: 'Schedule Call', desc: 'Plan a private grief support session' },
        { name: 'Send Care Package', desc: 'Coordinate support with your community' }
      ];

      const featuresHTML = features.map(feature => `
        <div class="social-item">
          <div class="social-icon">
            <i class="fas fa-${feature.name.toLowerCase().includes('call') ? 'phone' : feature.name.toLowerCase().includes('share') ? 'share' : feature.name.toLowerCase().includes('photo') ? 'images' : 'heart'}"></i>
          </div>
          <div class="social-info">
            <div class="social-name">${feature.name}</div>
            <div class="social-meta">${feature.desc}</div>
          </div>
          <i class="fas fa-chevron-right" style="color: #a0aec0;"></i>
        </div>
      `).join('');

      socialFeatures.innerHTML = featuresHTML;
    }

    // Track current active page
    let currentActivePage = null;

    // Add navigation event listeners
    document.querySelectorAll('.nav-item[data-page]').forEach(item => {
      item.addEventListener('click', function() {
        const page = this.getAttribute('data-page');
        
        // If clicking the same active page, close it (toggle)
        if (currentActivePage === page) {
          // Reset to default
          document.querySelectorAll('.nav-item').forEach(navItem => {
            navItem.classList.remove('active');
          });
          loadAllPosts();
          currentActivePage = null;
          return;
        }
        
        // Remove active class from all nav items
        document.querySelectorAll('.nav-item').forEach(navItem => {
          navItem.classList.remove('active');
        });
        
        // Add active class to clicked item
        this.classList.add('active');
        
        // Show appropriate content based on clicked page
        if (page === 'community') {
          showGroups();
          currentActivePage = 'community';
        } else if (page === 'notifications') {
          showNotifications();
          currentActivePage = 'notifications';
        } else if (page === 'resources') {
          showSocialFeatures();
          currentActivePage = 'resources';
        } else {
          // For other pages, just reset to default
          loadAllPosts();
          currentActivePage = null;
        }
      });
    });

    document.addEventListener('DOMContentLoaded', function() {
      loadAllPosts();
      updateLoginButton(); // Check login status when page loads
    });
  </script>
</body>
</html>
